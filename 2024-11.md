# 11/22
  - LINE認証を追加

# 11/23
  - ngnokを追加

    > 使い方
    > 最初のみ(設定していないとBlocked hostエラーが出る)
    > `config/environments/development.rb`に`config.hosts << ".ngrok-free.app"`を追加
    dockerを再起動
    > 
    > Windowマークを右クリック => Windows PowerShellを開く
    > コマンド`ngrok http 3000(外部公開したいlocalhost環境)`を実行

# 11/24

# 11/25
  - LINEログインへのパスoauth/lineでUnsafeRedirectエラーを解消
    - `login_at(auth_params[:provider], allow_other_host: true)`と`allow_other_host: true`を追加するも、解消されず。login_atメソッドにより直接リダイレクトではないから効いてない？
      > UnsafeRedirectError
      > Railsの設定で`config.action_controller.raise_on_open_redirects :true`で外部のURLにリダイレクトされるのを防いでいるため。外部ホストを含むURLを許可する際はredirect_toの呼び出しに`allow_other_host: true`オプションを追加する必要がある。
    - `config/environments/development.rb`に`config.action_controller.raise_on_open_redirects = false`を追加しdocker再起動。エラーは解消できた。が、セキュリティリスクは増してしまうから、`allow_other_host: true`オプションで解決できるように今後したいところ。
  - LINEログイン画面の400エラー(Invalid redirect_uri)を解消
    - LINE Developers側でコールバック先URLを設定していなかったため、LINEログイン設定>コールバックURLに追加。ログインできたが、開発者ロールを設定していないため400エラー。デプロイ後に要確認。＋でLINE Developersで「メールアドレス取得権限」申請があるが、これを申請でメールアドレスが取得できそう。現状でログイン問題なければこのままでも？
  - しおり詳細画面のマップ表示を修正(Maps JavaScript API)
    => ngrokを使えば開発環境で確認できると思ったけど、できなかった。[参考サイト](https://qiita.com/lemonade_37/items/51ca0f18fd9da842bb00)より「APIキーの設定・表示確認」を導入してみるとマップが表示されるように。Google CloudのAPIとサービス>認証情報>APIキーを選択>アプリケーションの制限の設定をウェブサイトに設定、localhostでも問題なく表示された。`show.html.erb`のビューの中でマップ表示のjsを記述しているが、`google_map.js`に移動させたらマップが表示されなくなった。`application.js`でimportされていない？jsファイルにすると記述が足りない？
  - プランの場所入力にオートコンプリート機能を追加(計画)
    [参考サイト・前半](https://qiita.com/lemonade_37/items/51ca0f18fd9da842bb00)
    [参考サイト・後半](https://qiita.com/lemonade_37/items/0cf88a654b18a73b16f5)
    - plansテーブルでlocationをstring型=>Text型、緯度経度のカラムを追加。まず、`rails g migration change_location_to_text_in_plans`でカラム型変更のマイグレーションファイルを生成、編集。
      ```
      def change
        change_column :plans, :location, :text
      end
      ```
      `rails db:migrate`でDBに反映させる。
      次に、`rails g migration AddLatitudeAndLongitudeToPlans Latitude:float Longitude:float`でカラム追加のマイグレーションファイルを生成。
      ```
      def change
        add_column :plans, :latitude, :float
        add_column :plans, :longitude, :float
      end
      ```
      マイグレーションファイルの内容を確認し、`rails db:migrate`。Booksコントローラーのストロングパラメーターへも追加。
    - Gemを追加。Gemfileに`gem "geocoder"`を追加し、`bundle install`=>`rails g geocoder:config`。生成される`config/initializers/geocoder.rb`を編集。
      ```
      Geocoder.configure(
        lookup: :google,
        use_https: true,
        api_key: API_KEY, 
      )
      ```
    - Plan.rbにアソシエーション追加。
      ```
      class Plan < ApplicationRecord
        geocoded_by :address
        after_validation :geocode
      end
      ```
    - `show.html.erb`の＜script＞を編集。planのlatitudeとlongitudeは`null: false`をつけていないので、存在する場合のみマーカーを立てるように指示。
      ```
      <% @book.plans.each do |plan| %>
        <% if plan.latitude.present? && plan.longitude.present? %>
          new google.maps.Marker({
            position: {lat: <%= plan.latitude %>, lng: <%= plan.longitude %>}, 
            map: map,
          });
        <% end %>
      <% end %>
      ```
    - planのフォーム部分を編集。各フィールド部分にid、scriptタグを追加。
    - JSファイルを作成。
    > 以上の流れについてロボらんてくんに添削済。後半をもう少し詳細にしていくのとJSでさジェクト機能を追加することを考慮(JQuery UI, Typeahead.js)。

  # 11/26
    - オートコンプリート機能を追加
      昨日の予定に沿って実装していく。以下追加。
      - planのフォーム部分でlocationにidを追加、scriptタグを追加。
        ```
        # books/new.html.erb
        ...
          <%= f.fields_for :plans do |plan_form| %>
          ...
            <div class="col-md-9 mb-3">
              <%= plan_form.text_field :location, `id: "location"` class: "form-control", placeholder: "場所" %>
            </div>
            ...
          <% end %>
        </div>
        ...
        ```
        jsでプラン追加もしているので、同様にlocationにidを追加。
        ```
        # plans.js
        ...
        <div class="col-md-9 mb-3">
          <input type="text" name="book[plans_attributes][${planIndex}][location]", id="location",  class="form-control" placeholder="場所" />
        </div>
        ...
        ```
        jsファイルを作成、編集。
        ```
        # location_autocomplete.js
        document.addEventListener("turbo:load", function() {
          const inputLocation = document.getElementById('location');

          const options = {
            types: ['establishment'],
            componentRestrictions: { country: 'JP' },
          };

          const autocompleteLocation = new google.maps.places.Autocomplete(inputLocation, options);

          autocompleteLocation.addListener('place_changed', function() {
            const place = autocompleteAddress.getPlace();
            inputLocation.value = place.formatted_address;
          });
        });
        ```
      => マーカー表示されるが1つのプランのみ。さらに、マーカー表示されているプラン以外は消えてしまう。検証ツールでエラーが出ているので修正。
        - Uncaught (in promise) InvalidValueError: initMap is not a function
          => Promiseオブジェクト(JSで標準で組み込まれている、非同期処理の成功失敗を知らせるもの)がキャッチできていない＝処理されていない？`initMap is not a function`より、APIは読み取っているが関数をコールバックできていない。< script src=>をapplication.html.erbに記述して、< script>はshow.html.erbと分けていたのが原因そう。< script src=>をshoe.html.erbの< script>直下にしてエラー解消。[参考](https://zenn.dev/swata_dev/articles/8fd821dc56086e)
          => これだと直下のmultiple timesエラーが生じてしまった。Google Maps APIのスクリプトは全ページで一度だけ読み込むべきだそう。通常はapplication.html.erbなどのレイアウトファイルで読み込むのが良く、これで複数回読み込むことを防げる(ロボらんてくん)。ということで、show.html.erbにはマップの要素のみを残し、script類はapplication.html.erbへ。
          => < script>内に@bookを記述していてBooks#indexでエラー。< script>は再度show.html.erbとし、
        - You have included the Google Maps JavaScript API multiple times on this page. This may cause unexpected errors.(しおり詳細画面)
          => 上記エラー修正中に解消。
        - しおり詳細画面でマップが表示されない。更新すると表示。
          => 前も同様の現象があり、turboが関わっていそう。Turboのイベントリスナーを追加し、ページが読み込まれたときにinitMapを呼び出すように。
          => 今度はしおりいちらん画面で`Uncaught InvalidValueError: Map: Expected mapDiv of type HTMLElement but was passed null.`のエラー。map要素がないため出ていたので、initMap関数を呼び出す前に分岐で解消。





      


  [ ] APIキーの保存場所
     よく分かっていないままKEY部分にペーストしていた。.gitignoreを使うんだろうけど、よく分からないままとりあえず開発を進めようとしていたため、やらねば。
     API入力しているファイル：app/views/books/show.html.erb、config/initializers/geocoder.rb
  [ ] しおりへの画像添付がエラーになっているままか確認。

  本リリース後
  [ ] 管理画面（ユーザー、しおりを管理）